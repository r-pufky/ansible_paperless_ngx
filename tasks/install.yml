---
###############################################################################
# Install Packages & Services
###############################################################################
# Manually download, extract, build, and install packages accordingly to Linux
# FHS standards:
#
# Type    | Perms               | Path
# --------|---------------------|-------
# Source  | 0755/0644 root:root | /opt/*
# Runtime | 0750/0640 SRV:SRV   | /var/opt/paperless
# Config  | 0640 SRV:SRV        | /etc/opt/paperless
#
# Installation notes:
# * Redis is installed with default configuration if enabled.
# * OCR packages are installed if OCR is enabled, including tesseract OCR data.
# * JBIG2enc is used for lossless PDF/A compression (not listed in bare-metal
#   instructions) but used in Docker configuration which is based on Bookworm.
# * Use source ghostscript to reduce vulnerability exposure.
# * NLTK is installed and extra data is downloaded if specified.
# * All database libraries are installed.
#
# Reference:
# * https://docs.paperless-ngx.com/setup/#bare_metal
# * https://redis.io/docs/getting-started/#securing-redis
# * https://docs.paperless-ngx.com/configuration/

- name: 'Install | filesystem | set system directories'
  ansible.builtin.file:
    path: '{{ item }}'
    owner: 'root'
    group: 'root'
    mode: '0755'
    state: 'directory'
  loop:
    - '{{ paperless_ngx___app._src_dir }}'  # src_dir includes opt_dir.
    - '{{ paperless_ngx___jb2e._src_dir }}'
    - '{{ paperless_ngx___gs._src_dir }}'
    - '{{ paperless_ngx___nltk._opt_dir }}'

- name: 'Install | filesystem | set paperless directories'
  ansible.builtin.file:
    path: '{{ item }}'
    owner: '{{ paperless_ngx__cfg._uid }}'
    group: '{{ paperless_ngx__cfg._gid }}'
    mode: '0750'
    state: 'directory'
  loop:
    - '{{ paperless_ngx___app._etc_dir }}'
    - '{{ paperless_ngx___app._var_dir ~ "/consume" }}'
    - '{{ paperless_ngx___app._var_dir ~ "/data" }}'
    - '{{ paperless_ngx___app._var_dir ~ "/trash" }}'
    - '{{ paperless_ngx___app._var_dir ~ "/media" }}'

- name: 'Install | packages'
  ansible.builtin.include_role:
    name: 'r_pufky.deb.apt'
  vars:
    apt_packages:
      - '{{ paperless_ngx___packages }}'
      - '{{ paperless_ngx___redis if paperless_ngx__srv._redis else [] }}'
      - '{{ paperless_ngx__cfg._ocr_languages }}'
    apt_package_update_cache: true

- name: 'Install | systemd | start redis-server'
  when: paperless_ngx__srv._redis
  ansible.builtin.systemd:
    name: 'redis-server'
    enabled: true
    daemon_reload: true
    state: 'started'

###############################################################################
# Paperless-NGX
###############################################################################

- name: 'Install | filesystem | find previous installations'
  ansible.builtin.find:
    paths: '{{ paperless_ngx___app._src_dir }}'
    file_type: 'directory'
    recurse: false
    excludes:
      - '{{ paperless_ngx__srv._version }}'
  register: paperless_ngx__cmd

- name: 'Install | filesystem | remove previous installations'
  ansible.builtin.file:
    path: '{{ item.path }}'
    state: 'absent'
  loop: '{{ paperless_ngx__cmd.files }}'

- name: 'Install | filesystem | stage paperless-ngx'
  when: not (url_inject_enable | default(false))
  ansible.builtin.get_url:
    url: '{{ paperless_ngx__cfg._url }}'
    dest: '{{ "/tmp/" ~ paperless_ngx__cfg._package }}'
    force: false
    owner: 'root'
    group: 'root'
    mode: '0644'
    headers:
      Authorization: '{{ paperless_ngx__srv._token | default(omit) }}'
  register: paperless_ngx__cmd
  until: paperless_ngx__cmd is succeeded

- name: '{{ "Install | filesystem | set " ~ paperless_ngx___app._live_dir }}'
  ansible.builtin.file:
    path: '{{ paperless_ngx___app._live_dir }}'
    owner: 'root'
    group: 'root'
    mode: '0755'
    state: 'directory'

- name: 'Install | filesystem | unpack paperless-ngx'
  ansible.builtin.unarchive:
    creates: '{{ paperless_ngx___app._work_dir ~ "/manage.py" }}'
    src: '{{ "/tmp/" ~ paperless_ngx__cfg._package }}'
    remote_src: true
    dest: '{{ paperless_ngx___app._live_dir }}'
    owner: 'root'
    group: 'root'
    mode: 'a-st'
    extra_opts: ['--strip-components=1']
    exclude:
      - 'docker'
      - 'docs'
      - '.dockerignore'
      - '.env'
      - 'Dockerfile'
      - 'LICENSE'
      - 'README.md'
      # Never store user data in /opt.
      - 'data'
      - 'trash'
      - 'consume'
      - 'media'

- name: 'Install | filesystem | rename template paperless.conf'
  ansible.builtin.command:
    argv:
      - 'mv'
      - '{{ paperless_ngx___app._live_dir ~ "/paperless.conf" }}'
      - '{{ paperless_ngx___app._live_dir ~ "/paperless.conf.template" }}'
    creates: '{{ paperless_ngx___app._live_dir ~ "/paperless.conf.template" }}'

- name:
    '{{ "Install | filesystem | set minimal " ~ paperless_ngx___app._cfg }}'
  when: paperless_ngx__cfg._file | length == 0
  ansible.builtin.template:
    src: 'paperless.conf.j2'
    dest: '{{ paperless_ngx___app._cfg }}'
    owner: '{{ paperless_ngx__cfg._uid }}'
    group: '{{ paperless_ngx__cfg._gid }}'
    mode: '0640'

- name: 'Install | filesystem | unstage paperless-ngx'
  when: not (url_inject_enable | default(false))
  ansible.builtin.file:
    path: '{{ "/tmp/" ~ paperless_ngx__cfg._package }}'
    state: 'absent'

###############################################################################
# JBIG2enc
###############################################################################

- name: 'Install | filesystem | find previous installations'
  ansible.builtin.find:
    paths: '{{ paperless_ngx___jb2e._src_dir }}'
    file_type: 'directory'
    recurse: false
    excludes:
      - '{{ paperless_ngx___jb2e._version }}'
  register: paperless_ngx__cmd

- name: 'Install | filesystem | remove previous installations'
  ansible.builtin.file:
    path: '{{ item.path }}'
    state: 'absent'
  loop: '{{ paperless_ngx__cmd.files }}'

- name: 'Install | filesystem | stage JBIG2enc'
  when: not (url_inject_enable | default(false))
  ansible.builtin.get_url:
    url: '{{ paperless_ngx___jb2e._url }}'
    dest: '{{ "/tmp/" ~ paperless_ngx___jb2e._package }}'
    force: false
    owner: 'root'
    group: 'root'
    mode: '0644'
    headers:
      Authorization: '{{ paperless_ngx__srv._token | default(omit) }}'
  register: paperless_ngx__cmd
  until: paperless_ngx__cmd is succeeded

- name: '{{ "Install | filesystem | set " ~ paperless_ngx___jb2e._live_dir }}'
  ansible.builtin.file:
    path: '{{ paperless_ngx___jb2e._live_dir }}'
    owner: 'root'
    group: 'root'
    mode: '0755'
    state: 'directory'

- name: 'Install | filesystem | unpack JBIG2enc'
  ansible.builtin.unarchive:
    creates: '{{ paperless_ngx___jb2e._live_dir ~ "/src/jbig2.cc" }}'
    src: '{{ "/tmp/" ~ paperless_ngx___jb2e._package }}'
    remote_src: true
    dest: '{{ paperless_ngx___jb2e._live_dir }}'
    owner: 'root'
    group: 'root'
    mode: 'a-st'
    extra_opts: ['--strip-components=1']
  register: paperless_ngx__cmd

- name: 'Install | build | JBIG2enc (~1 minute) ðŸ—˜'
  when: paperless_ngx__cmd.changed  # noqa: no-handler immediate
  ansible.builtin.debug:
    msg: 'Building JBIG2enc (~1 minute).'

- name: '{{ "Install | build | JBIG2enc " ~ paperless_ngx___jb2e._version }}'
  when: paperless_ngx__cmd.changed  # noqa: no-handler immediate
  ansible.builtin.shell: >-
    set -o pipefail &&
    ./autogen.sh &&
    ./configure &&
    make install
  args:
    executable: '/bin/bash'
    chdir: '{{ paperless_ngx___jb2e._live_dir }}'
  changed_when: paperless_ngx__cmd.rc == 0
  register: paperless_ngx__cmd

- name: 'Install | filesystem | unstage JBIG2enc'
  when: not (url_inject_enable | default(false))
  ansible.builtin.file:
    path: '{{ "/tmp/" ~ paperless_ngx___jb2e._package }}'
    state: 'absent'

###############################################################################
# Ghostscript
###############################################################################

- name: 'Install | filesystem | find previous installations'
  ansible.builtin.find:
    paths: '{{ paperless_ngx___gs._src_dir }}'
    file_type: 'directory'
    recurse: false
    excludes:
      - '{{ paperless_ngx___gs._version }}'
  register: paperless_ngx__cmd

- name: 'Install | filesystem | remove previous installations'
  ansible.builtin.file:
    path: '{{ item.path }}'
    state: 'absent'
  loop: '{{ paperless_ngx__cmd.files }}'

- name: 'Install | filesystem | stage Ghostscript'
  when: not (url_inject_enable | default(false))
  ansible.builtin.get_url:
    url: '{{ paperless_ngx___gs._url }}'
    dest: '{{ "/tmp/" ~ paperless_ngx___gs._package }}'
    force: false
    owner: 'root'
    group: 'root'
    mode: '0644'
    headers:
      Authorization: '{{ paperless_ngx__srv._token | default(omit) }}'
  register: paperless_ngx__cmd
  until: paperless_ngx__cmd is succeeded

- name: '{{ "Install | filesystem | set " ~ paperless_ngx___gs._live_dir }}'
  ansible.builtin.file:
    path: '{{ paperless_ngx___gs._live_dir }}'
    owner: 'root'
    group: 'root'
    mode: '0755'
    state: 'directory'

- name: 'Install | filesystem | unpack Ghostscript'
  ansible.builtin.unarchive:
    creates: '{{ paperless_ngx___gs._live_dir ~ "/base/gslib.c" }}'
    src: '{{ "/tmp/" ~ paperless_ngx___gs._package }}'
    remote_src: true
    dest: '{{ paperless_ngx___gs._live_dir }}'
    owner: 'root'
    group: 'root'
    mode: 'a-st'
    extra_opts: ['--strip-components=1']
  register: paperless_ngx__cmd

- name: 'Install | build | Ghostscript (~4 minutes) ðŸ—˜'
  when: paperless_ngx__cmd.changed  # noqa: no-handler immediate
  ansible.builtin.debug:
    msg: 'Building Ghostscript (~4 minutes).'

- name: '{{ "Install | build | Ghostscript " ~ paperless_ngx___gs._version }}'
  when: paperless_ngx__cmd.changed  # noqa: no-handler immediate
  ansible.builtin.shell: >-
    set -o pipefail &&
    ./configure &&
    make &&
    make install
  args:
    executable: '/bin/bash'
    chdir: '{{ paperless_ngx___gs._live_dir }}'
  changed_when: paperless_ngx__cmd.rc == 0
  register: paperless_ngx__cmd

- name: 'Install | filesystem | unstage Ghostscript'
  when: not (url_inject_enable | default(false))
  ansible.builtin.file:
    path: '{{ "/tmp/" ~ paperless_ngx___gs._package }}'
    state: 'absent'

###############################################################################
# Virtual Environment
###############################################################################
# Debian tox-uv does not install the UV binary. Setup UV binary in paperless
# user home directory. UV environment already exists in paperless source -
# configure with standard /opt permissions.

- name: 'Install | filesystem | download uv'
  ansible.builtin.shell: >-
    set -o pipefail &&
    curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    executable: '/bin/bash'
    creates: '{{ paperless_ngx__cfg._uv }}'
  become: true
  become_user: '{{ paperless_ngx__srv._user }}'

- name: 'Install | uv | init uv (~1 minute) ðŸ—˜'
  ansible.builtin.shell: '{{ paperless_ngx__cfg._uv ~ " sync --all-extras" }}'
  args:
    executable: '/bin/bash'
    chdir: '{{ paperless_ngx___app._live_dir }}'
    creates: '{{ paperless_ngx___app._venv_dir }}'

###############################################################################
# NLTK Libraries
###############################################################################

- name: 'Install | uv | install NLTK (~1 minute) ðŸ—˜'
  ansible.builtin.shell: '{{
      paperless_ngx__cfg._uv ~ " add " ~
      paperless_ngx___nltk._packages | join(" ")
    }}'
  args:
    executable: '/bin/bash'
    chdir: '{{ paperless_ngx___app._live_dir }}'
    creates: '{{ paperless_ngx___app._live_dir ~ "/bin/nltk" }}'

- name: 'Install | uv | download NLTK data (~1 minute) ðŸ—˜'
  when: paperless_ngx__cfg._nltk_data | length > 0
  ansible.builtin.shell: '{{
      paperless_ngx__cfg._uv ~ " run python " ~
      "-W ignore::RuntimeWarning " ~
      "-m nltk.downloader " ~
      "-d " ~
      paperless_ngx___nltk._opt_dir ~ " " ~
      paperless_ngx__cfg._nltk_data | join(" ")
    }}'
  args:
    executable: '/bin/bash'
    chdir: '{{ paperless_ngx___app._live_dir }}'
  register: paperless_ngx__cmd
  changed_when: '"already up-to-date" not in paperless_ngx__cmd.stderr'

###############################################################################
# ImageMagick
###############################################################################
# Enable PDF processing with imagemagick.
#
# ImageMagick-7 now provides read/write examples which cause regex replacement
# to fail. Instead count read/write PDF lines and append at end of policy if
# not found.
#

- name: 'Install | filesystem | query /etc/ImageMagick-7/policy.xml'
  ansible.builtin.shell: >-
    set -o pipefail &&
    grep -c 'rights="read|write" pattern="PDF"'
    /etc/ImageMagick-7/policy.xml
  changed_when: false
  failed_when: paperless_ngx__cmd.rc > 1
  register: paperless_ngx__cmd

- name: 'Install | filesystem | enable ImageMagick PDF processing'
  when: paperless_ngx__cmd.stdout == '0'
  ansible.builtin.lineinfile:
    path: /etc/ImageMagick-7/policy.xml
    search_string: '</policymap>'
    line: |2
        <policy domain="coder" rights="read|write" pattern="PDF" />
      </policymap>

# Services requiring paperless.conf settings are updated in systemd.yml.
- name: 'Install | systemd | set services'
  ansible.builtin.template:
    src: '{{ "systemd/" ~ item ~ ".j2" }}'
    dest: '{{ "/etc/systemd/system/" ~ item }}'
    owner: 'root'
    group: 'root'
    mode: '0644'
  loop:
    - 'paperless_cache.timer'
    - 'paperless_consumer.service'
    - 'paperless_scheduler.service'
    - 'paperless_task_queue.service'
